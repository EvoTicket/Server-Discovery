name: Deploy to VPS with Docker

on:
  push:
    branches:
      - 'release*'
      - 'release/**'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.extract_info.outputs.version }}
      image_tag: ${{ steps.extract_info.outputs.image_tag }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract branch name and version
        id: extract_info
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # Táº¡o version tá»« tÃªn nhÃ¡nh (vÃ­ dá»¥: release/v1.0.0 -> v1.0.0)
          if [[ $BRANCH_NAME == release/* ]]; then
            VERSION=${BRANCH_NAME#release/}
          else
            # Náº¿u chá»‰ lÃ  "release" hoáº·c "release-xxx", dÃ¹ng timestamp
            VERSION="v$(date +'%Y.%m.%d-%H%M%S')"
          fi
          
          # Táº¡o image tag (loáº¡i bá» kÃ½ tá»± Ä‘áº·c biá»‡t khÃ´ng há»£p lá»‡ cho Docker tag)
          IMAGE_TAG=$(echo "$VERSION" | tr '/' '-')
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"
          echo "ðŸ·ï¸ Image Tag: $IMAGE_TAG"

      - name: Check if tag exists
        id: check_tag
        run: |
          VERSION="${{ steps.extract_info.outputs.version }}"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Tag $VERSION already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Tag $VERSION does not exist"
          fi

      - name: Create and push tag
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.extract_info.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git tag -a "$VERSION" -m "Release $VERSION from ${{ steps.extract_info.outputs.branch }}"
          git push origin "$VERSION"
          
          echo "ðŸ·ï¸ Tag $VERSION created and pushed"

      - name: Generate release notes
        id: release_notes
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.extract_info.outputs.version }}"
          BRANCH="${{ steps.extract_info.outputs.branch }}"
          
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" -10)
          else
            COMMITS=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s (%h)")
          fi
          
          cat << EOF > release_notes.md
          ## ðŸš€ Release $VERSION
          
          **Branch:** \`$BRANCH\`
          **Date:** $(date +'%Y-%m-%d %H:%M:%S')
          **Docker Image:** \`${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}:${{ steps.extract_info.outputs.image_tag }}\`
          
          ### ðŸ“ Changes
          $COMMITS
          
          ### ðŸ”— Links
          - [View diff](https://github.com/${{ github.repository }}/compare/$PREVIOUS_TAG...$VERSION)
          - [Docker Hub](https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }})
          EOF

      - name: Create GitHub Release
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.extract_info.outputs.version }}
          name: Release ${{ steps.extract_info.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}:${{ steps.extract_info.outputs.image_tag }}
            ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}:buildcache,mode=max

  deploy-to-vps:
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            cd ${{ secrets.VPS_DEPLOY_PATH || '~/app' }}
            
            # Backup file .env hiá»‡n táº¡i (náº¿u cÃ³)
            if [ -f .env ]; then
              cp .env .env.backup
            fi
            
            # Update image tag trong docker-compose.yml
            export IMAGE_TAG=${{ needs.build-and-push.outputs.image_tag }}
            export DOCKER_IMAGE=${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}
            
            # Pull image má»›i nháº¥t
            docker pull ${DOCKER_IMAGE}:${IMAGE_TAG}
            
            # Stop vÃ  remove container cÅ©
            docker-compose down
            
            # Start vá»›i image má»›i
            docker-compose up -d
            
            # Clean up old images (giá»¯ láº¡i 3 images gáº§n nháº¥t)
            docker image prune -af --filter "until=72h"
            
            echo "âœ… Deployment completed successfully!"
            echo "ðŸ³ Image: ${DOCKER_IMAGE}:${IMAGE_TAG}"

      - name: Deployment Summary
        if: success()
        run: |
          echo "### âœ… Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ needs.build-and-push.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Image:** \`${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_IMAGE_NAME }}:${{ needs.build-and-push.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** Deployed to VPS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View logs: \`ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} 'cd ${{ secrets.VPS_DEPLOY_PATH || '~/app' }} && docker-compose logs -f'\`" >> $GITHUB_STEP_SUMMARY
